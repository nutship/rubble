### 1. 编译过程

### 2. 目标文件

#### (1). 分类

<font class="u_n">

objected files come in three forms:

-   executable object file:
    -   当前流行的格式主要为 Windows 的 PE & Linux 的 ELF，可以直接加载到内存执行
-   relocatable object file (Windows: `.obj` & Linux: `.o`):
    -   用于链接成可执行文件和共享目标文件
-   shared object file (Windows: `.dll` & Linux: `.so`):
    -   可以与其他可重定位目标文件/共享目标文件链接，产生新的目标文件；也可以与可执行文件结合，作为进程映像的一部分运行

</font>

??? hint "可执行文件格式的历史"

    Unix 最早的可执行文件格式是 a.out，但由于其设计过于简单，无法适应共享库的概念；Unix System V Release 3 首先提出并使用了 COFF 格式，微软基于 COFF 提出了 PE 格式标准；System V Release 4 引入了 ELF 格式，也就是当前 Linux 的可执行文件格式。

#### (2). 格式

典型的 ELF 可重定位目标文件包含以下 section:

<font class="t_a%0&0_b%10_h%3&0">

| section                | description                                                                   |
| :--------------------- | :---------------------------------------------------------------------------- |
| `.text`                | 已编译程序的机器码                                                            |
| `.rodata`              | 只读数据，如 `printf` 的 format 串、`switch` 的跳转表                         |
| `.data`                | 已初始化的全局和静态变量                                                      |
| `.bss`<rspan>3</rspan> | 未初始化 / 初始化为 0 的全局和静态变量 (可用 better save space 记忆)          |
| &emsp;                 | 只是占位符，不占实际空间，段表存储其大小，符号表存储符号                      |
| &emsp;                 | 运行时为其中变量分配空间，初值为 0                                            |
| `.symtab`              | 符号表，定义 & 引用的全局变量或函数的信息                                     |
| `.rel.text`            | -                                                                             |
| `.rel.data`            | -                                                                             |
| `.debug`               | (`-g`) 调试符号表，条目包括局部变量和类型定义、定义和引用的全局变量、C 源文件 |
| `.line`                | (`-g`) 原始 C 源程序中的行号和 `.text` 中机器指令中的映射                     |
| `.strtab`              | 字符串表，表中的内容会被 `.symtab`、`.debug`、section header table 引用       |

</font>

将代码段和数据段分开存储的好处:

-   程序装载后，数据和指令映射到两个虚存区域，对于进程数据区可读写，指令区只读，方便权限控制
-   有利于程序局部性
-   当系统中运行同一程序的多个副本，所有只读区只需要保存一份，这是一个很重要的概念

### 3. ELF 文件结构
